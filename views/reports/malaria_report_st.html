<head>
    <title>
        Malaria Report
    </title>
<link rel="stylesheet" href="/public/touchscreentoolkit/lib/stylesheets/touch-fancy.css" type="text/css">

<script type="text/javascript" src="/apps/OPD/assets/js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="/assets/js/core.js"></script>

<link rel="stylesheet" type="text/css" href="/apps/OPD/assets/css/DataTables/jquery.dataTables.min.css"/>
<script type="text/javascript" src="/apps/OPD/assets/js/DataTables/datatables.min.js"></script>

<script type="text/javascript" src="/assets/js/datatables/dataTables.buttons.min.js"></script>
<script type='text/javascript' src='/assets/js/datatables/jszip.min.js'></script>
<script type='text/javascript' src='/assets/js/datatables/pdfmake.min.js'></script>
<script type='text/javascript' src='/assets/js/datatables/vfs_fonts.js'></script>
<script type='text/javascript' src='/assets/js/datatables/buttons.html5.min.js'></script>
<script type='text/javascript' src='/assets/js/datatables/buttons.print.min.js'></script>

<script type="text/javascript" src="/assets/js/moment.js"></script>

<script type="text/javascript" src="/assets/js/virtual.keyboard.js"></script>

<style>
    div {
    -moz-user-select: unset;
    cursor: pointer;
}
    #spinner {
        position: absolute;
        top: 15%;
        left: 40%;
    }

    #report-cover {
        position: absolute;
        background-color: black;
        width: 100%;
        height: 102%;
        left: 0%;
        top: 0%;
        z-index: 990;
        opacity: 0.65;
    }

    .min-tables {
        width: 100%;
        text-align: right;
    }

    .min-tables {
        border-left: 1px solid #111;
    }

    .tbody-rows td{
        border-bottom: 1px solid #111;
    }

    .tbody-rows :first-child {
        border-right: 2px solid #111;
        border-left: 2px solid #111;
        padding-right: 1%;
    }

    .tbody-rows :last-child {
        border-right: 2px solid #111;
        border-left: 1px solid #111;
    }

    .title-table {
        display: table;
        width: 100%;
    }

    .title-row {
        display: table-row;
    }

    .title-cell {
        display: table-cell;
        height: 30px;
        vertical-align: top;
        border-style: solid;
        border-width: 0px 0px 1px 0px;
    }

    #title-cell-left {
        vertical-align: middle;
        width: 100px;
    }

    #title-cell-left img {
        height: 95px;
        width: 95px;
        margin: 5px;
    }

    #title-cell-right {
        margin-left: 5px;
    }

    #data-cell {
        display: table-cell;
        width: 100%;
    }

    #report {
        width: 100%;
    }
    .buttonsDiv 
    {
    top: 770px;
    }
    td{
        text-align: left;
    }

</style>

</head>
<div class="title-table">
    <div class='title-row'>
        <div class='title-cell' id='title-cell-left'>
            <img src="/assets/images/login-logos/Malawi-Coat_of_arms_of_arms.png"/>
        </div>
        <div class='title-cell' id='title-cell-right'>
            <table style="width: 100%; text-align: left; margin-left: 10px;">
                <tr>
                    <th>Title:</th>
                    <td colspan="2" id="report-title">Malaria Report
                    <td>
                </tr>
                <tr>
                    <th>Period:</th>
                    <td id="start-date">
                    <td>
                    <td id="end-date">
                    <td>
                </tr>
            </table>
        </div>
    </div>
</div>

<div class="title-table">
    <div class='title-row'>
        <div id='data-cell'>
            <table id="report" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>Out Patient Department</th>
                        <th>
                            <table class='min-tables'>
                                <tr><td colspan=1>Out Patient Numbers</td></tr> <tr><td>    &#60;5 yrs</td></tr>
                            </table>
                        </th>
    
                        <th>
                            <table class='min-tables'>
                                <tr><td colspan=1>.</td></tr> <tr><td>    &#62;5 yrs</td></tr>
                            </table>
                        </th>
                    </tr>
                </thead>
                <tbody class="tbody-rows">
                    <tr>
                        <td class="first-td">Confirmed (Co) Malaria Cases</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Presumed (Pr) Malaria Cases (Clinically Diagnosed)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Confirmed malaria in pregnant woman (c)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Presumed (clinically diagnosed) malaria in pregnant woman (d)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Confirmed (Co) Malaria Cases</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr class="tr-last">
                        <td class="first-td">Total OPD Attendance: All causes (Including malaria cases)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>

                    <tr class="tr-head">
                        <td class="first-td thead-f">Treatment in OPD</td>
                        <td class="td-f"></td>
                        <td class="td-f"></td>
                    </tr>
                    <tr>
                        <td class="first-td">Confirmed cases receiving first-line anti malarial medication (LA)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Presumed malaria cases receiving first-line anti malarial medication(LA)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Confirmed cases receiving second-line anti malarial medication (ASAQ)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Presumed malaria cases receiving second-line anti malarial medication(ASAQ)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>

                    <tr class="tr-head">
                        <td class="first-td thead-f">Lab/mRDT in OPD</td>
                        <td class="td-f"></td>
                        <td class="td-f"></td>
                    </tr>
                    <tr>
                        <td class="first-td">Suspected malaria cases tested (mRDT)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Positive malaria cases (mRDT)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Suspected malaria cases tested (microscopy)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Positive malaria cases (microscopy)</td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td class="first-td">Total suspected malaria cases </td>
                        <td>0</td>
                        <td>0</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<div id="buttons" class="buttonsDiv">
    <button class="button green navButton" onmousedown="location='/'"><span>Finish</span></button>
</div>

<img src="/apps/OPD/assets/images/formloader.gif" id="spinner"/>
<div id="report-cover"></div>


<style>
    .modal
    {
        position: fixed;
        width: 70%;
        background-color: #fff;
        margin-left: 15%;
        top: 0%;
        border: solid 1px;
        z-index: 990;
    }
    
    button.red 
    {
        border: solid #842020; 
        border-radius: 3px;
        padding: 10px;
        background-size: 100%;
        float:left;
        margin: 10px;
    }
    button.red:hover 
    {
        background-size: 225%;
    }
   
   
    .sorting_patient 
    {
        background-color: #b9b9b9;
    }
    
    ._title
    {
        display: flex;
        justify-content: center;
        font-size: 20px;
        padding:3px;
    }
    

    .modal-header{
        padding: 10px;
    }
    thead {
    text-align: center;
    }
    th
    {
        width:248px !important;
    }
    table.dataTable thead th, table.dataTable thead td {
      
        padding-left: 3px;
        padding: 0px 0px;
        padding-left: 0px;
        border-bottom: 0px none;
    }
    .dataTables_scrollHead {
        border: 2px solid #111 !important;
        width: inherit !important;
    }

    .thead-f {
        text-align: center;
        background-color: white;
        font-weight: bold;
        border-right: 0px none !important;
    }

    .tr-head {
        border: 2px solid #111;
    }

    .tr-head td{
        border-bottom: 2px solid #111;
    }

    .tr-last td{
        border-bottom: 2px solid #111 !important;
    }

    .td-f {
        background-color: white;
        border-left: 0px none !important;
    }

    .nm {
        border-bottom: solid !important;
    }

    .themAll {
        border-top: 1px solid #111 !important; 
        border-bottom: 1px solid #111;
    }
    
    </style>
<!-- Modal -->
<div class="modal " id="modal" style="display: none;" > 
    <div class="modal-content" style="margin-left:0px; ">
        <div class="modal-header">
            <div class="modal-title _title" ></div>
            <div class="period _title" ></div>
        </div>
        <div class="modal-body">
            <div class="container">
                <div class="row" id="modal-div">
                    <div id="patient_details_card" style="margin-bottom: 10px; border-bottom: 1px solid;" >
                        <table id="patient_details_table" class="display " >
                            <thead>
                            <tr>
                                <th class="sorting_patient" >Patient ID</th>
                                <th class="sorting_patient">Firstname</th>
                                <th class="sorting_patient">Surname</th>
                                <th class="sorting_patient">Gender</th>
                                <th class="sorting_patient">Phone Number</th>
                                <th class="sorting_patient">Address</th>
                            </tr>
                            </thead>
                            <tbody id="patient_details_body">
                            </tbody>
                        </table>
                       
                    </div>
                </div>
            </div>
        </div>
        <div class="bottom_buttons">
            <button class="red"  onclick="close_modal()">Close</button>
        </div>
    </div> 
</div>
<!-- Modal -->
<script>

    function myFunction() {

    var headElements = document.getElementsByClassName('border_lines');
    var testDivs = Array.prototype.filter.call(headElements, function(headElement){
        z = headElement.parentElement;
        z.setAttribute('class','themAll');
    });
    }

    var url = window.location.href;
    url = new URL(url);
    var report_type = url.searchParams.get("type");
    var start_date = url.searchParams.get("start_date");
    var end_date = url.searchParams.get("end_date");

    document.getElementById('start-date').innerHTML = moment(start_date).format('DD/MMM/YYYY');
    document.getElementById('end-date').innerHTML = moment(end_date).format('DD/MMM/YYYY');

    function buildReportingTable() {
        initializeTable();
        getData();
    }

    var table_columns = [];

    var data_table;

    function initializeTable() {
        data_table = $('#report').DataTable({
            fixedHeader: true,
            searching: true,
            paging: false,
            ordering: false,
            scrollY: 430,
            Processing: true,
            ServerSide: true,
            scroller: {
                loadingIndicator: true
            },
            dom: 'Bfrtip',
            buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
        });

        lookForTag();
    }

    function initializeTable_Modal() {
        table = $('#patient_details_table').DataTable({
            fixedHeader: true,
            searching: true,
            paging: true,
            scrollY: 520,
            Processing: true,
            ServerSide: true,
            scroller: {
                loadingIndicator: true
            },
            dom: 'Bfrtip',
            buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
        });

        lookForTag();
    }

    function getData() {

        var url = apiProtocol + "://" + apiURL + ":" + apiPort + "/api/v1";
        url += '/malaria_report?start_date=' + start_date;
        url += '&end_date=' + end_date + "&date=" + sessionStorage.sessionDate;
        url += '&program_id=' + sessionStorage.programID;

        if (apiProtocol == undefined) {
            setTimeout("getData()", 3000);
            return;
        }

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
                document.getElementById('spinner').style = 'display: none;';
                document.getElementById('report-cover').style = 'display: none;';
                var obj = JSON.parse(this.responseText);
                //loadData(obj);
                myFunction();
            }
        };
        xhttp.open("GET", url, true);
        xhttp.setRequestHeader('Authorization', sessionStorage.getItem("authorization"));
        xhttp.setRequestHeader('Content-type', "application/json");
        xhttp.send();
    }

    function loadData(data) 
    {
        var count = 0;
        var patientsD_counter = 0;

                var total_patients = "";
                total_patients = data['patientD_confirmed_malaria_cases'];


                var total_patients_pr = "";
                total_patients_pr = data['patientD_presumed_malaria_cases'];

                var total_patients_ls_5 = "";
                total_patients_ls_5 = data['patientD_confirmed_malaria_cases_less_than_five_years'];

                var total_patients_gtr_5 = "";
                total_patients_gtr_5 = data['patientD_confirmed_malaria_cases_greater_than_five_years'];


                var total_patients_pr_ls_5 = "";
                total_patients_pr_ls_5 = data['patientD_presumed_malaria_cases_less_than_five_years'];

                var total_patients_pr_gtr_5 = "";
                total_patients_pr_gtr_5 = data['patientD_presumed_malaria_cases_greater_than_five_years'];

                sessionStorage.setItem("total_patients"+patientsD_counter, total_patients);
                sessionStorage.setItem("total_patients_pr"+patientsD_counter, total_patients_pr);
                sessionStorage.setItem("total_patients_ls_5"+patientsD_counter, total_patients_ls_5);
                sessionStorage.setItem("total_patients_gtr_5"+patientsD_counter, total_patients_gtr_5);
                sessionStorage.setItem("total_patients_pr_ls_5"+patientsD_counter, total_patients_pr_ls_5);
                sessionStorage.setItem("total_patients_pr_gtr_5"+patientsD_counter, total_patients_pr_gtr_5);

                total_patients = "total_patients"+patientsD_counter;
                total_patients_pr = "total_patients_pr"+patientsD_counter;
                total_patients_ls_5 = "total_patients_ls_5"+patientsD_counter;
                total_patients_gtr_5 = "total_patients_gtr_5"+patientsD_counter;
                total_patients_pr_ls_5 = "total_patients_pr_ls_5"+patientsD_counter;
                total_patients_pr_gtr_5 = "total_patients_pr_gtr_5"+patientsD_counter;


                data_table.row.add(['<h3 class="border_lines">Out Patient Department</h3>', 
                    lessThanFive(),
                    greaterThanFive(),
                    total()]);
                
                data_table.row.add(['Confirmed (Co) Malaria Cases', 
                    buildTotal(data['confirmed_malaria_cases_less_than_five_years'],total_patients_ls_5),

                    buildTotal(data['confirmed_malaria_cases_greater_than_five_years'],total_patients_gtr_5),
                    
                    buildTotal(data['confirmed_malaria_cases'],total_patients)]);
                    
                data_table.row.add(['Presumed (Pr) Malaria Cases (Clinically Diagnosed )', 
                    buildTotal(data['presumed_malaria_cases_less_than_five_years'],total_patients_pr_ls_5),

                    buildTotal(data['presumed_malaria_cases_greater_than_five_years'],total_patients_pr_gtr_5),
                    
                    buildTotal(data['presumed_malaria_cases'],total_patients_pr)]);
                data_table.row.add(['Confirmed malaria in pregnant woman (c)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.row.add(['Presumed (clinically diagnosed) malaria in pregnant woman (d)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.row.add(['Total OPD Malaria Cases (A+B+C+D)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.row.add(['Total OPD Attendance: All causes (Including malaria cases)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.row.add(['Confirmed malaria treatment failure (tf)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);

                data_table.row.add(['<h3 class="border_lines">Treatment in OPD</h3>', 
                    lessThanFive(),
                    greaterThanFive(),
                    total()]);
                data_table.row.add(['Confirmed cases receiving first-line anti malarial medication (LA)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.row.add(['Presumed malaria cases receiving first-line anti malarial medication(LA)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.row.add(['Confirmed cases receiving second-line anti malarial medication (ASAQ)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.row.add(['Presumed malaria cases receiving second-line anti malarial medication(ASAQ)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);

                data_table.row.add(['<h3 class="border_lines">Treatment in OPD</h3>', 
                    lessThanFive(),
                    greaterThanFive(),
                    total()]);
                data_table.row.add(['Confirmed cases receiving first-line anti malarial medication (LA)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.row.add(['Presumed malaria cases receiving first-line anti malarial medication(LA)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.row.add(['Confirmed cases receiving second-line anti malarial medication (ASAQ)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.row.add(['Presumed malaria cases receiving second-line anti malarial medication(ASAQ)', 
                    buildTotal(0,0),
                    buildTotal(0,0),
                    buildTotal(0,0)]);
                data_table.draw();
                

                count++;
                patientsD_counter++;
                if (count == 99) {
                    count = 0;
                    sleep(3000);
                } 
            
        

           /* for (var diagnosis in data) {

                

                if (diagnosis == 'Malaria')
                {
                    
                    console.log( diagnosis);
                    //console.log(data[diagnosis]);

                    var total_patients = 0;

                    console.log(data[diagnosis].female_less_than_five_yrs);
                    //console.log(data[diagnosis].patientD_F_LessThanFiveYrs); 
                    console.log(data[diagnosis].male_less_than_five_yrs);
                    //console.log(data[diagnosis].patientD_M_LessThanFiveYrs);


                    console.log(data[diagnosis].female_six_months_to_less_than_five_yrs);
                    //console.log(data[diagnosis].patientD_confirmed_malaria_cases_less_than_five_years);
                    console.log(data[diagnosis].male_six_months_to_less_than_five_yrs);
                    //console.log(data[diagnosis].patientD_M_LessFiveYrs);

                    data_table.row.add(['Confirmed (Co) Malaria Cases',data[diagnosis].female_less_than_five_yrs,
                                                                       data[diagnosis].male_less_than_five_yrs,
                                                                       data[diagnosis].female_six_months_to_less_than_five_yrs,
                                                                       data[diagnosis].male_six_months_to_less_than_five_yrs,0
                
                    ]);

                    data_table.row.add(['Presumed (Pr) Malaria Cases (Clinically Diagnosed )',data[diagnosis].female_less_than_five_yrs,
                                                                       data[diagnosis].male_less_than_five_yrs,
                                                                       data[diagnosis].female_six_months_to_less_than_five_yrs,
                                                                       data[diagnosis].male_six_months_to_less_than_five_yrs,0
                
                    ]);
                    data_table.draw();
                    
                } 
    } */
}

    function lessThanFive() {
        var div = document.createElement('div');
        div.setAttribute('class','border_lines');
        div.innerHTML = '<div style="border-bottom: 1px solid #111;margin-top: 8px;"></div>';
        var span = document.createElement('div');
        span.innerHTML = '&#60; 5 yr';
        span.appendChild(div);
        return span.innerHTML;
    }

    function greaterThanFive() {
        var div = document.createElement('div');
        div.setAttribute('class','border_lines');
        div.innerHTML = '<div style="border-bottom: 1px solid #111;margin-top: 8px;"></div>';
        var span = document.createElement('div');
        span.innerHTML = '&#62; 5 yr';
        span.appendChild(div);
        return span.innerHTML;
    }

    function total() {
        var div = document.createElement('div');
        div.setAttribute('class','border_lines');
        div.innerHTML = '<div style="margin-top: 8px;"></div>';
        var span = document.createElement('div');
        span.innerHTML = '<span style="font-weight: bold;">Total</span>';
        span.appendChild(div);
        return span.innerHTML;
    }
     
    function buildMinStat(patientD,period) 
    {
        var sp = document.createElement('span');
        var table = document.createElement('table');
        table.setAttribute('class', 'min-tables');
        var tr = document.createElement('tr');
        table.appendChild(tr);

        var td = document.createElement('td');
        td.setAttribute('onclick', "view_patientD('"+patientD+"','"+period+"')");
        td.setAttribute('id',patientD);
        td.innerHTML = patientD;
        tr.appendChild(td);

        sp.appendChild(table);
        return sp.innerHTML;
    }

    function buildMinStatFemale(female, patientD_F, diagnosis,period)
    {
       return buildMinStat(female, patientD_F, diagnosis,period);
    } 
    function buildMinStatMale(male, patientD_M,diagnosis,period)
    {
        return buildMinStat(male, patientD_M,diagnosis,period);
    }


    function view_patientD(patientD,period)
    {
        if($('#virtual-keyboard').length)
            hide_keyboard();

        $('.keyboard').attr('style','display:none');
        $('#spinner').attr('style','display:block');
        $('#report-cover').attr('style','display:block');
        var y = $("#"+patientD).html();
        var mil = y*40;
        setTimeout(function(){ dataTableContentLoader(patientD,period); },mil);
    }

    function dataTableContentLoader(patientD,period)
    {   console.log("he2: "+patientD);
        patientD = sessionStorage.getItem(patientD);
        $('.modal-title').html('<b>Diagnosis:</b> &nbsp;&nbsp; ' + "here");
        $('.period').html('  &nbsp;&nbsp;' + period);
        if(period == "")
        $('.period').attr('style','display:none')
        document.getElementById('modal').setAttribute('style','display:block');
        patientD = patientD.substring(2);
        patientD = patientD.split('|');
        patientD = patientD.sort();
     
        $('#patient_details_body').html('');
        patientD.forEach(value1 => 
        {
            var value = value1.split(',');
                
            var tr = document.createElement('tr');
            document.getElementById('patient_details_body').appendChild(tr);

            var td = document.createElement('td');
            td.innerHTML = value[1];
            tr.appendChild(td);

            td = document.createElement('td');
            td.innerHTML = value[0];
            tr.appendChild(td);

            var td = document.createElement('td');
            td.innerHTML = value[2];
            tr.appendChild(td);

            td = document.createElement('td');
            td.innerHTML = value[3];
            tr.appendChild(td);

            td = document.createElement('td');
            td.innerHTML = value[4];
            tr.appendChild(td);
            
            td = document.createElement('td');
            td.innerHTML = value[5];
            tr.appendChild(td);

        });
        

        document.getElementById('spinner').style = 'display: none;';
        //add export data buttons
        initializeTable_Modal();

        $("label [aria-controls*='report']").attr('type','text');
    }

    function close_modal()
    {
        $("label [aria-controls*='report']").attr('type','search');
        $('#report-cover').attr('style','display:none');
        document.getElementById('patient_details_body').innerHTML = "";
        document.getElementById('modal').setAttribute('style','display:none');
        table.destroy();
        hide_keyboard();
    }

    function hide_keyboard()
    {
        var vl = document.getElementById('virtual-keyboard');
        var w = document.getElementsByTagName('body')[0];
        w.removeChild(vl);
    }
    function buildTotal(total,total_patients) 
    {
        var sp = document.createElement('span');
        var table = document.createElement('table');
        table.setAttribute('class', 'min-tables');
        var tr = document.createElement('tr');
        table.appendChild(tr);

        var td = document.createElement('td');
        td.setAttribute('onclick', "view_patientD('"+total_patients+"','')");
        td.setAttribute('id',total_patients);
        td.innerHTML = total;
        tr.appendChild(td);
        sp.appendChild(table);
        return sp.innerHTML;
    }

    buildReportingTable();
    
</script>


